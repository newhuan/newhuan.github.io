# 部署架构演进

## 目的

 理解大型分布式架构的演进历史、技术原理、最佳实践
## 技术背景说明
我们都知道一个成熟的大型网站的系统架构并非一开始就设计的非常完美，也没有一开始就具备高性能、高并发、高可用、安全性等特性，而是随着用户量的增加、业务功能的扩展逐步演变过来的，慢慢的完善的。 在这个过程中，开发模式、技术架构等都会随着迭代发生非常大的变化。 而针对不同业务特征的系统，各自都会有自己的侧重点，例如像淘宝这类的网站，要解决的重点问题就是海量商品搜索、下单、支付等问题; 像腾讯这类的网站，要解决的是数亿级别用户的实时消息传输;而像百度这类的公司所要解决的又是海量数据的搜索。每一个种类的业务都有自己不同的系统架构。

## 概括

1. 应用架构
2. 应用服务器和数据库服务器分离
3. 应用服务器集群

4. 数据库压力变大，数据库读写分离
5. 使用搜索引擎缓解读库的压力
6. 引入缓存机制缓解数据库的压力
7. 数据库的水平/垂直拆分
8. 应用的拆分

可以按照：**背景、目标、核心问题、方案、收益、成本、优势、劣势**的结构重新梳理下

![img](../../../../../../../../images/ar/ar0.png)

## 原文

为了方便展开本文要讲解的内容，我们来简单模拟一个架构演变过程： 我们以 javaweb 为例，来搭建一个简单的电商系统，从这个系统中来看系统的演变过程。要注意的是接下来的演示模型， 关注的是数据量、访问量提升，网站结构的变化， 而不关注具体业务的功能点。其次，这个过程是为了让大家能更好的了解网站演进过程中的一些问题和应对策略。
假如我们要设计的互联网系统需要具备以下功能:
1）用户模块：用户注册和管理；
2）商品模块:商品展示和管理；
3）交易模块:创建交易及支付结算。
请带着上述3个技术点，继续深入阅读本文的正文内容。干货马上开始了。。。
4、架构演进阶段一：单应用架构

![img](../../../../../../../../images/ar/ar1.webp)


如上图所示，这个阶段是网站的初期，也可以认为是互联网发展的早期，系统架构如上图所示。我们经常会在单台服务器上运行我们所有的程序和软件。 把所有软件和应用都部署在一台机器上，这样就完成一个简单系统的搭建，这个阶段的讲究的是效率。效率决定生死。
5、架构演进阶段二：应用服务器和数据库服务器分离
随着网站的上线，访问量逐步上升，服务器的负载慢慢提高，我们应该在服务器还没有超载的时候就做好规划、提升网站的负载能力。假若此时已经没办法在代码层面继续优化提高，那么在单台机器的性能遇到瓶颈的时候，增加机器是一个比较简单好用的方式，投入产出比相当高。这个阶段增加机器的主要目的是将 web 服务器和 数据库服务器拆分开来，这样做的话不仅提高了单机的负载能力，也提高了整个系统的容灾能力。

![img](../../../../../../../../images/ar/ar2.webp)

这个阶段的系统架构如上图所示，应用服务器和数据库服务器完全隔离开来，相互互不影响，大大减少了网站宕机的风险，此阶段我们已经开始关注到应用服务器的管理了。
6、架构演进阶段三：应用服务器集群
这个阶段，随着访问量的继续不断增加，单台应用服务器已经无法满足我们的需求。 假设我的数据库服务器还没有遇到性能问题，那我们可以通过增加应用服务器的方式来将应用服务器集群化，这样就可以将用户请求分流到各个服务器中，从而达到继续提升系统负载能力的目的。此时各个应用服务器之间没有直接的交互，他们都是依赖数据库各自对外提供服务。

![img](../../../../../../../../images/ar/ar3.webp)

系统架构发展到这个阶段，各种问题也会接踵而至：
1）用户请求交由谁来转发到具体的应用服务器上(谁来负责负载均衡)；
2）用户如果每次访问到的服务器不一样，那么如何维护session，达到session共享的目的。
那么此时，系统架构又会变成如下方式：

<img src="../../../../../../../../images/ar/ar4.webp" alt="img" style="zoom:50%;" />

负载均衡又可以分为软负载和硬负载。软负载我们可以选择Nginx、Apache等，硬负载我们可以选择F5等。而session共享问题我们可以通过配置tomcat的session共享解决。
7、架构演进阶段四：数据库压力变大，数据库读写分离
架构演变到上面的阶段，并不是终点。通过上面的设计，应用层的性能被我们拉上来了， 但数据库的负载也在逐渐增大，那如何去提高数据库层面的性能呢？有了前面的设计思路以后，我们自然也会想到通过增加服务器来提高性能。但假如我们单纯的把数据库一分为二，然后对于数据库的请求，分别负载到两台数据库服务器上，那必定会造成数据库数据不统一的问题。
所以我们一般先考虑将数据库读写分离，如下图所示。

<img src="../../../../../../../../images/ar/ar5.webp" alt="img" style="zoom:50%;" />

这个架构设计的变化会带来如下几个问题：
1）主从数据库之间的数据需要同步(可以使用 mysql 自带的 master-slave 方式实现主从复制 )；
2）应用中需要根据业务进行对应数据源的选择( 采用第三方数据库中间件，例如 mycat )。
8、架构演进阶段五：使用搜索引擎缓解读库的压力
我们都知道数据库常常对模糊查找效率不是很高，像电商类的网站，搜索是非常核心的功能，即使是做了读写分离，这个问题也不能得到有效解决。那么这个时候我们就需要引入搜索引擎了，使用搜索引擎能够大大提升我们系统的查询速度，但同时也会带来一 些附加的问题，比如维护索引的构建、数据同步到搜索引擎等。

<img src="../../../../../../../../images/ar/ar6.webp" alt="img" style="zoom:50%;" />

9、架构演进阶段六：引入缓存机制缓解数据库的压力
然后，随着访问量的持续不断增加，逐渐会出现许多用户访问同一内容的情况，那么对于这些热点数据，没必要每次都从数据库重读取，这时我们可以使用到缓存技术，比如 redis、memcache 来作为我们应用层的缓存。
另外在某些场景下，如我们对用户的某些 IP 的访问频率做限制， 那这个放内存中就又不合适，放数据库又太麻烦了，那这个时候可以使用 Nosql 的方式比如 mongDB 来代替传统的关系型数据库。

<img src="../../../../../../../../images/ar/ar7.webp" alt="img" style="zoom:50%;" />

10、架构演进阶段七：数据库的水平/垂直拆分
我们的网站演进的变化过程，交易、商品、用户的数据都还在同一 个数据库中，尽管采取了增加缓存，读写分离的方式，但是随着数 据库的压力持续增加，数据库的瓶颈仍然是个最大的问题。因此我 们可以考虑对数据的垂直拆分和水平拆分。

<img src="../../../../../../../../images/ar/ar8.webp" alt="img" style="zoom:50%;" />

垂直拆分：把数据库中不同业务数据拆分到不同的数据库；
水平拆分：把同一个表中的数据拆分到两个甚至更多的数据库中，水平拆分的原因是某些业务数据量已经达到了单个数据库的瓶颈，这时可以采取将表拆分到多个数据库中。

<img src="../../../../../../../../images/ar/ar9.webp" alt="img" style="zoom:50%;" />

11、架构演进阶段八：应用的拆分
随着业务的发展，业务量越来越大，应用的压力越来越大。工程规模也越来越庞大。这个时候就可以考虑将应用拆分，按照领域模型将我们的用户、商品、交易拆分成多个子系统。

<img src="../../../../../../../../images/ar/ar10.webp" alt="img" style="zoom:50%;" />


这样拆分以后，可能会有一些相同的代码，比如用户操作，在商品和交易都需要查询，所以会导致每个系统都会有用户查询访问相关操作。这些相同的操作一定是要抽象出来，否则就是一个坑。所以通过走服务化路线的方式来解决。

<img src="../../../../../../../../images/ar/ar11.webp" alt="img" style="zoom:50%;" />

那么服务拆分以后，各个服务之间如何进行远程通信呢? 通过 RPC 技术，比较典型的有:dubbo、webservice、hessian、http、RMI 等等。前期通过这些技术能够很好的解决各个服务之间通信问题，但是， 互联网的发展是持续的，所以架构的演变和优化也还在持续。
12、本文小结
通过本文，我们通过一个电商的案例，就了解到了分布式架构的演进过程，一环套一环，环环紧密相扣。都是通过业务量和访问量的提升来考虑重构架构设计，以便能够适应当前的环境。不可一蹴而就，也急不来，初创企业必须稳扎稳打，一步一个脚印的走出一条专属自己的路。
本文主要针对的是零基础初学者，如果您想深入了解相关知识，请继续阅读《[腾讯资深架构师干货总结：一文读懂大型分布式系统设计的方方面面](https://link.zhihu.com/?target=http%3A//www.52im.net/thread-1811-1-1.html)》。
附录：更多架构方面的技术文章

《[浅谈IM系统的架构设计](https://link.zhihu.com/?target=http%3A//www.52im.net/thread-307-1-1.html)》
《[简述移动端IM开发的那些坑：架构设计、通信协议和客户端](https://link.zhihu.com/?target=http%3A//www.52im.net/thread-289-1-1.html)》
《[一套海量在线用户的移动端IM架构设计实践分享(含详细图文)](https://link.zhihu.com/?target=http%3A//www.52im.net/thread-812-1-1.html)》
《[一套原创分布式即时通讯(IM)系统理论架构方案](https://link.zhihu.com/?target=http%3A//www.52im.net/thread-151-1-1.html)》
《[从零到卓越：京东客服即时通讯系统的技术架构演进历程](https://link.zhihu.com/?target=http%3A//www.52im.net/thread-152-1-1.html)》
《[蘑菇街即时通讯/IM服务器开发之架构选择](https://link.zhihu.com/?target=http%3A//www.52im.net/thread-31-1-1.html)》
《[腾讯QQ1.4亿在线用户的技术挑战和架构演进之路PPT](https://link.zhihu.com/?target=http%3A//www.52im.net/thread-158-1-1.html)》
《[微信后台基于时间序的海量数据冷热分级架构设计实践](https://link.zhihu.com/?target=http%3A//www.52im.net/thread-895-1-1.html)》
《[微信技术总监谈架构：微信之道——大道至简(演讲全文)](https://link.zhihu.com/?target=http%3A//www.52im.net/thread-200-1-1.html)》
《[如何解读《微信技术总监谈架构：微信之道——大道至简》](https://link.zhihu.com/?target=http%3A//www.52im.net/thread-201-1-1.html)》
《[快速裂变：见证微信强大后台架构从0到1的演进历程（一）](https://link.zhihu.com/?target=http%3A//www.52im.net/thread-168-1-1.html)》
《[17年的实践：腾讯海量产品的技术方法论](https://link.zhihu.com/?target=http%3A//www.52im.net/thread-159-1-1.html)》
《[移动端IM中大规模群消息的推送如何保证效率、实时性？](https://link.zhihu.com/?target=http%3A//www.52im.net/thread-1221-1-1.html)》
《[现代IM系统中聊天消息的同步和存储方案探讨](https://link.zhihu.com/?target=http%3A//www.52im.net/thread-1230-1-1.html)》
《[IM开发基础知识补课(二)：如何设计大量图片文件的服务端存储架构？](https://link.zhihu.com/?target=http%3A//www.52im.net/thread-1356-1-1.html)》
《[IM开发基础知识补课(三)：快速理解服务端数据库读写分离原理及实践建议](https://link.zhihu.com/?target=http%3A//www.52im.net/thread-1366-1-1.html)》
《[IM开发基础知识补课(四)：正确理解HTTP短连接中的Cookie、Session和Token](https://link.zhihu.com/?target=http%3A//www.52im.net/thread-1525-1-1.html)》
《[WhatsApp技术实践分享：32人工程团队创造的技术神话](https://link.zhihu.com/?target=http%3A//www.52im.net/thread-1542-1-1.html)》
《[微信朋友圈千亿访问量背后的技术挑战和实践总结](https://link.zhihu.com/?target=http%3A//www.52im.net/thread-1569-1-1.html)》
《[王者荣耀2亿用户量的背后：产品定位、技术架构、网络方案等](https://link.zhihu.com/?target=http%3A//www.52im.net/thread-1595-1-1.html)》
《[IM系统的MQ消息中间件选型：Kafka还是RabbitMQ？](https://link.zhihu.com/?target=http%3A//www.52im.net/thread-1647-1-1.html)》
《[腾讯资深架构师干货总结：一文读懂大型分布式系统设计的方方面面](https://link.zhihu.com/?target=http%3A//www.52im.net/thread-1811-1-1.html)》
《[以微博类应用场景为例，总结海量社交系统的架构设计步骤](https://link.zhihu.com/?target=http%3A//www.52im.net/thread-1910-1-1.html)》
《[快速理解高性能HTTP服务端的负载均衡技术原理](https://link.zhihu.com/?target=http%3A//www.52im.net/thread-1950-1-1.html)》
《[子弹短信光鲜的背后：网易云信首席架构师分享亿级IM平台的技术实践](https://link.zhihu.com/?target=http%3A//www.52im.net/thread-1961-1-1.html)》
《[知乎技术分享：从单机到2000万QPS并发的Redis高性能缓存实践之路](https://link.zhihu.com/?target=http%3A//www.52im.net/thread-1968-1-1.html)》
《[IM开发基础知识补课(五)：通俗易懂，正确理解并用好MQ消息队列](https://link.zhihu.com/?target=http%3A//www.52im.net/thread-1979-1-1.html)》
《[微信技术分享：微信的海量IM聊天消息序列号生成实践（算法原理篇）](https://link.zhihu.com/?target=http%3A//www.52im.net/thread-1998-1-1.html)》
《[微信技术分享：微信的海量IM聊天消息序列号生成实践（容灾方案篇）](https://link.zhihu.com/?target=http%3A//www.52im.net/thread-1999-1-1.html)》
《[新手入门：零基础理解大型分布式架构的演进历史、技术原理、最佳实践](https://link.zhihu.com/?target=http%3A//www.52im.net/thread-2007-1-1.html)》